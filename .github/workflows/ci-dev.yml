name: Continuous Integration (Development)

on:
    push:
        branches: ["dev"]
    pull_request:
        branches: ["dev"]
        types: ["opened", "synchronize", "reopened", "ready_for_review"]

permissions:
    contents: read

concurrency:
    group: dev-ci-${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || github.ref }}
    cancel-in-progress: true
    
jobs:
    ci:
        name: Continuous Integration (Dev)
        environment: dev
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.draft == false }}
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Write .env for build
              shell: bash
              run: |
                set -euo pipefail

                ENV_FILE=".env.local"

                cat > "${ENV_FILE}" << 'EOF'
                PUBLIC_SITE_URL=${{ vars.PUBLIC_SITE_URL }}
                PUBLIC_API_KEY=${{ secrets.PUBLIC_API_KEY }}
                PUBLIC_AUTH_DOMAIN=${{ vars.PUBLIC_AUTH_DOMAIN }}
                PUBLIC_DATABASE_URL=${{ vars.PUBLIC_DATABASE_URL }}
                PUBLIC_PROJECT_ID=${{ vars.PUBLIC_PROJECT_ID }}
                PUBLIC_STORAGE_BUCKET=${{ vars.PUBLIC_STORAGE_BUCKET }}
                PUBLIC_MESSAGING_SENDER_ID=${{ vars.PUBLIC_MESSAGING_SENDER_ID }}
                PUBLIC_APP_ID=${{ secrets.PUBLIC_APP_ID }}
                PUBLIC_MEASUREMENT_ID=${{ vars.PUBLIC_MEASUREMENT_ID }}
                PUBLIC_RECAPTCHA_SITE_KEY=${{ secrets.PUBLIC_RECAPTCHA_SITE_KEY }}
                PUBLIC_API_URL=${{ vars.PUBLIC_API_URL }}
                NODE_ENV=development
                EOF

                echo "Wrote ${ENV_FILE} with $(wc -l < ${ENV_FILE}) entries"

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                node-version: 20
                cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Typecheck (Astro)
              run: npm run typecheck

            - name: Lint
              run: npm run lint --if-present

            - name: Test
              run: npm test --if-present

            - name: Build
              run: npm run build
