---
import { getCollection } from 'astro:content';
import BlogLayout from "../../layouts/BlogLayout.astro";
import Header from "../../components/blog/react/Header";
import Footer from "../../components/blog/Footer.astro";
import BreadcrumbNav from "../../components/blog/BreadcrumbNav.astro";
import ArticleCard from "../../components/blog/ArticleCard.astro";
import { searchContent, getCategories } from "../../content/config";
import { Search as SearchIcon, FolderOpen, Tag, FileText } from "lucide-react";

const query = Astro.url.searchParams.get("q")?.trim() || "";
const results = query.length >= 1 ? await searchContent(query, 50) : [];

const categoriesEntries = await getCategories();
const categories = categoriesEntries.map(c => c.data);

// Group results by type
const articleResults = results.filter(r => r.type === "article");
const categoryResults = results.filter(r => r.type === "category");
const subcategoryResults = results.filter(r => r.type === "subcategory");
const tagResults = results.filter(r => r.type === "tag");

// Get matching articles for display
const matchingArticleIds = articleResults.map(r => r.url.replace("/blog/", ""));
const allArticles = await getCollection('blog');
const matchingArticles = allArticles.filter(a => matchingArticleIds.includes(a.id));

const breadcrumbs = [
  { label: "Home", href: "/" },
  { label: "Blog", href: "/blog" },
  { label: "Search Results" },
];
---

<BlogLayout title={query ? `Search: ${query} | Oasis` : "Search | Oasis"}>
  <Header categories={categories} client:load />
  
  <main class="min-h-screen bg-background">
    <div class="mx-auto max-w-7xl px-4 py-8 lg:px-8">
      <BreadcrumbNav items={breadcrumbs} />
      
      <!-- Search Header -->
      <div class="mt-8 mb-10">
        <h1 class="font-serif text-3xl font-semibold text-foreground sm:text-4xl">
          {query ? `Search results for "${query}"` : "Search"}
        </h1>
        {query && results.length > 0 && (
          <p class="mt-2 text-muted-foreground">
            Found {results.length} result{results.length !== 1 ? "s" : ""}
          </p>
        )}
      </div>

      <!-- Search Form for re-searching -->
      <div class="mb-10">
        <form action="/blog/search" method="get" class="flex flex-col sm:flex-row gap-3 max-w-xl">
          <div class="relative flex-1">
            <SearchIcon className="absolute left-4 top-1/2 h-5 w-5 -translate-y-1/2 text-muted-foreground pointer-events-none" />
            <input
              type="text"
              name="q"
              value={query}
              placeholder="Search for topics, resources, or articles..."
              class="h-12 w-full rounded-lg border border-border bg-card pl-12 pr-4 text-base text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring"
            />
          </div>
          <button
            type="submit"
            class="w-full sm:w-auto h-12 rounded-lg bg-primary px-8 text-sm font-medium text-primary-foreground hover:bg-primary/90 transition-colors"
          >
            Search
          </button>
        </form>
      </div>

      {/* No Query State */}
      {!query && (
        <div class="text-center py-16">
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-muted mb-4">
            <SearchIcon className="h-8 w-8 text-muted-foreground" />
          </div>
          <h2 class="text-xl font-medium text-foreground mb-2">Start your search</h2>
          <p class="text-muted-foreground max-w-md mx-auto">
            Enter keywords above to find articles, topics, and resources across Oasis.
          </p>
          
          <!-- Popular Searches -->
          <div class="mt-8">
            <p class="text-sm text-muted-foreground mb-3">Popular searches:</p>
            <div class="flex flex-wrap justify-center gap-2">
              {["Anxiety", "Therapy", "Sleep", "Depression", "Coping Skills", "Self-Care"].map((term) => (
                <a
                  href={`/blog/search?q=${encodeURIComponent(term)}`}
                  class="px-4 py-2 rounded-full bg-card border border-border text-sm font-medium text-foreground hover:bg-muted transition-colors"
                >
                  {term}
                </a>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* No Results State */}
      {query && results.length === 0 && (
        <div class="text-center py-16">
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-muted mb-4">
            <SearchIcon className="h-8 w-8 text-muted-foreground" />
          </div>
          <h2 class="text-xl font-medium text-foreground mb-2">No results found</h2>
          <p class="text-muted-foreground max-w-md mx-auto mb-6">
            We couldn't find anything matching "{query}". Try different keywords or browse our categories.
          </p>
          
          <div class="flex flex-wrap justify-center gap-3">
            <a
              href="/blog"
              class="px-6 py-2.5 rounded-lg bg-primary text-sm font-medium text-primary-foreground hover:bg-primary/90 transition-colors"
            >
              Go to Blog
            </a>
            <a
              href="/blog/tags"
              class="px-6 py-2.5 rounded-lg bg-card border border-border text-sm font-medium text-foreground hover:bg-muted transition-colors"
            >
              Browse Tags
            </a>
          </div>
        </div>
      )}

      {/* Results */}
      {query && results.length > 0 && (
        <div class="space-y-12">
          {/* Categories & Topics */}
          {(categoryResults.length > 0 || subcategoryResults.length > 0) && (
            <section>
              <h2 class="text-xl font-semibold text-foreground mb-4 flex items-center gap-2">
                <FolderOpen className="h-5 w-5 text-primary" />
                Categories & Topics
              </h2>
              <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                {[...categoryResults, ...subcategoryResults].map((result) => (
                  <a
                    href={result.url}
                    class="block p-4 rounded-lg border border-border bg-card hover:bg-muted/50 transition-colors"
                  >
                    <div class="flex items-center gap-2 mb-1">
                      <span class="font-medium text-foreground">{result.title}</span>
                      <span class="text-xs px-1.5 py-0.5 rounded bg-muted text-muted-foreground">
                        {result.type === "category" ? "Category" : "Topic"}
                      </span>
                    </div>
                    <p class="text-sm text-muted-foreground line-clamp-2">{result.description}</p>
                    {result.category && (
                      <p class="text-xs text-muted-foreground/70 mt-2">in {result.category}</p>
                    )}
                  </a>
                ))}
              </div>
            </section>
          )}

          {/* Tags */}
          {tagResults.length > 0 && (
            <section>
              <h2 class="text-xl font-semibold text-foreground mb-4 flex items-center gap-2">
                <Tag className="h-5 w-5 text-primary" />
                Tags
              </h2>
              <div class="flex flex-wrap gap-2">
                {tagResults.map((result) => (
                  <a
                    href={result.url}
                    class="px-4 py-2 rounded-full bg-card border border-border text-sm font-medium text-foreground hover:bg-muted transition-colors"
                  >
                    {result.title}
                    <span class="ml-2 text-muted-foreground">({result.description.split(" ")[0]})</span>
                  </a>
                ))}
              </div>
            </section>
          )}

          {/* Articles */}
          {matchingArticles.length > 0 && (
            <section>
              <h2 class="text-xl font-semibold text-foreground mb-4 flex items-center gap-2">
                <FileText className="h-5 w-5 text-primary" />
                Articles ({matchingArticles.length})
              </h2>
              <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
                {matchingArticles.map((article) => (
                  <ArticleCard article={article} />
                ))}
              </div>
            </section>
          )}
        </div>
      )}
    </div>
  </main>
  <Footer />
</BlogLayout>
